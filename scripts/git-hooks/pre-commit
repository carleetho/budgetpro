#!/bin/bash

# Pre-commit hook to validate hexagonal boundaries in the domain layer

# Path to the validator jar
VALIDATOR_JAR="tools/domain-validator/target/domain-validator-1.0.0-SNAPSHOT.jar"

if [ ! -f "$VALIDATOR_JAR" ]; then
    echo "‚ö†Ô∏è  Boundary validator JAR not found. Skipping validation."
    echo "To enable validation, run: cd tools/domain-validator && ./mvnw package -DskipTests"
    exit 0
fi

# We scan the entire domain layer for simplicity in this version, 
# although we could optimize it to scan only staged files.
echo "üîç Validating architectural boundaries..."
java -jar "$VALIDATOR_JAR" validate-boundary -r backend/src/main/java/com/budgetpro/domain
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "‚ùå Error: Architectural boundary violations detected."
    echo "Review the messages above and fix forbidden imports before committing."
    exit 1
fi

echo "üîç Validating state machine transitions..."
java -jar "$VALIDATOR_JAR" validate-state-machine
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "‚ùå Error: Invalid state machine transitions detected."
    echo "Review the violations above and fix state transitions before committing."
    exit 1
fi

echo "‚úÖ All domain validations passed."
exit 0
